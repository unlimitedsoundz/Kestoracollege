(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,71189,e=>{"use strict";var t=e.i(8145);async function r(e,r){let s=(0,t.createAdminClient)();console.log(`[LMS Simulation] Provisioning account for ${e} (${r})...`);try{await new Promise(e=>setTimeout(e,800));let t=`LX-${Math.random().toString(36).substring(2,10).toUpperCase()}`,{error:a}=await s.from("students").update({lms_access_data:{account_provisioned:!0,provisioned_at:new Date().toISOString(),lms_token:t,sync_status:"SYNCED"}}).eq("id",e);if(a)throw a;return await s.from("audit_logs").insert({action:"LMS_ACCOUNT_PROVISIONED",entity_table:"students",entity_id:e,metadata:{lms_token:t,email:r}}),console.log(`[LMS Simulation] Account provisioned successfully for ${e}`),{success:!0,lmsToken:t}}catch(e){return console.error("[LMS Simulation] Provisioning failed:",e.message),{success:!1,error:e.message}}}async function s(e,r,s){let a=(0,t.createAdminClient)();console.log(`[LMS Simulation] Syncing module ${r} to LMS for student ${e}...`);try{return await new Promise(e=>setTimeout(e,500)),await a.from("audit_logs").insert({action:"LMS_COURSE_SYNC",entity_table:"module_enrollments",entity_id:`${e}:${r}`,metadata:{student_id:e,module_id:r,semester_id:s,status:"GRANTED"}}),console.log(`[LMS Simulation] Sync completed for ${e} -> ${r}`),{success:!0}}catch(e){return console.error("[LMS Simulation] Sync failed:",e.message),{success:!1,error:e.message}}}e.s(["provisionLmsAccount",()=>r,"syncEnrollmentToLms",()=>s])},16720,e=>{"use strict";var t=e.i(90615),r=e.i(8145),s=e.i(71189);async function a(e){let t=(0,r.createAdminClient)();try{let{data:r}=await t.from("it_assets").select("*").eq("auto_provision",!0);if(!r||0===r.length)return{success:!0,message:"No auto-provision assets configured"};let{data:s}=await t.from("student_it_access").select("asset_id").eq("student_id",e),a=new Set(s?.map(e=>e.asset_id)||[]),i=[];for(let s of r){if(a.has(s.id))continue;let r=function(e){switch(e){case"EMAIL":return{email:`student${Math.floor(1e4*Math.random())}@kestora.online`,password:"SET_ON_FIRST_LOGIN"};case"LMS":return{username:`student${Math.floor(1e4*Math.random())}`,access_token:`lms_${o()}`};case"VPN":return{vpn_key:o(),config_url:"https://vpn.kestora.online/config"};case"LIBRARY":return{library_id:`LIB${Math.floor(1e5*Math.random())}`,pin:Math.floor(1e3+9e3*Math.random()).toString()};case"VIRTUAL_LAB":return{lab_username:`vlab_${Math.floor(1e4*Math.random())}`,access_url:"https://labs.kestora.online"};default:return{license_key:o()}}}(s.asset_type),n=new Date;n.setFullYear(n.getFullYear()+1);let{data:l,error:u}=await t.from("student_it_access").insert({student_id:e,asset_id:s.id,credentials:r,activated_at:new Date().toISOString(),expires_at:n.toISOString(),status:"ACTIVE"}).select().single();!u&&l&&(i.push(l),await t.from("it_assets").update({current_usage:s.current_usage+1}).eq("id",s.id))}return{success:!0,provisioned:i}}catch(e){return{success:!1,error:e.message}}}function o(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}async function i(e){let o=await (0,t.createClient)(),i=(0,r.createAdminClient)(),{data:{user:n}}=await o.auth.getUser();if(!n)throw Error("Unauthorized");try{let{data:t,error:r}=await i.from("applications").select(`
                *,
                user:profiles(*),
                course:Course(*),
                offer:admission_offers!inner(*)
            `).eq("id",e).single();if(r||!t)throw console.error("App fetch error:",r),Error("Application not found");let o=Array.isArray(t.offer)?t.offer[0]:t.offer;if(!o)throw Error("Associated admission offer not found");let{data:l}=await i.from("tuition_payments").select("*").eq("offer_id",o.id).eq("status","COMPLETED").single();if("ENROLLED"===t.status)return{success:!0,message:"Student is already enrolled."};if("PAYMENT_SUBMITTED"!==t.status&&"OFFER_ACCEPTED"!==t.status)throw Error(`Invalid application status for enrollment: ${t.status}`);let{data:u}=await i.from("students").select("student_id").eq("application_id",e).single();if(u)return"ENROLLED"!==t.status&&await i.from("applications").update({status:"ENROLLED"}).eq("id",e),{success:!0,studentId:u.student_id,message:"Student was already enrolled."};let d=`SK${Math.floor(1e6+9e6*Math.random())}`,c=t.user;if(!c)throw Error("Applicant profile not found");let m=c.first_name||"Student",_=c.last_name||"Kestora",f=`${m.toLowerCase()}.${_.toLowerCase()}@kestora.online`.replace(/\s/g,""),p=0;for(;;){let{data:e}=await i.from("students").select("id").eq("institutional_email",f).single();if(!e)break;p++,f=`${m.toLowerCase()}.${_.toLowerCase()}${p}@kestora.online`.replace(/\s/g,"")}let{error:g,data:S}=await i.from("students").insert({user_id:t.user_id,student_id:d,application_id:e,program_id:t.course_id,enrollment_status:"ACTIVE",institutional_email:f,personal_email:c.email,start_date:new Date().toISOString(),expected_graduation_date:new Date(new Date().setFullYear(new Date().getFullYear()+3)).toISOString()}).select().single();if(g)throw console.error("SIS Creation Failed:",g),Error(`Failed to create student record: ${g.message}`);let{error:w}=await i.from("applications").update({status:"ENROLLED"}).eq("id",e);if(w)throw w;let{error:h}=await i.from("profiles").update({student_id:d,enrollment_date:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t.user_id);h&&console.error("Failed to update student profile with ID:",h),await i.from("audit_logs").insert({action:"ENROLLMENT_CONFIRMED",entity_table:"students",entity_id:d,actor_id:n.id,metadata:{previous_status:t.status,trigger:"TUITION_PAYMENT_VERIFIED",payment_ref:l?.transaction_reference,actor_role:n.id===t.user_id?"APPLICANT":"ADMIN"}});try{await (0,s.provisionLmsAccount)(S.id,f)}catch(e){console.error("LMS Provisioning deferred:",e)}try{await a(S.id)}catch(e){console.error("IT Materials provisioning deferred:",e)}return{success:!0,studentId:d}}catch(e){return console.error("Enrollment Error:",e),{success:!1,error:e.message||"Enrollment failed."}}}e.s(["confirmEnrollment",()=>i],16720)}]);